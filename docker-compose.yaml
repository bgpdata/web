#####
# BGPDATA - BGP Data Collection and Analytics Service
# 
# This software is part of the BGPDATA project, which is designed to collect, process, and analyze BGP data from various sources.
# It helps researchers and network operators get insights into their network by providing a scalable and reliable way to analyze and inspect historical and live BGP data from Route Collectors around the world.
# 
# Author: Robin Röper
# 
# © 2024 BGPDATA. All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:
# 1. Redistributions of source code must retain the above copyright notice, this list of conditions, and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright notice, this list of conditions, and the following disclaimer in the documentation and/or other materials provided with the distribution.
# 3. Neither the name of BGPDATA nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#####
services:
    ####
    # Core Application Services
    #
    # The following services form the core of the application, providing essential
    # meta databases, near-realtime aggregation infrastructure and web applications.
    #
    # The 'core-db' service manages the PostgreSQL database, utilizing TimescaleDB for
    # efficient handling of time-series data.
    #
    # The 'core-web' service is the main application server, built with Flask
    # and served using Gunicorn with Uvicorn workers for asynchronous processing.
    #
    # The 'core-collector' service connects to RIPE NCC's Kafka stream, processes BGP messages,
    # and stores them in the PostgreSQL database.
    #
    # The 'core-aggregator' service periodically analyzes the collected data to aggregate
    # additional information from the OpenBMP database and store it in the PostgreSQL database.
    ####
    core-db:
        image: timescale/timescaledb:latest-pg13
        container_name: core-db
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U core -d default"]
            interval: 30s
            timeout: 10s
            retries: 5
        environment:
            POSTGRES_USER: core
            POSTGRES_PASSWORD: core
            POSTGRES_DB: default
        ports:
            - "5432:5432"
        volumes:
            - core_pg_data:/var/lib/postgresql/data

    core-web:
        build: .
        container_name: core-web
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:8080"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        environment:
            POSTGRESQL_DATABASE: postgresql+asyncpg://core:core@core-db:5432/default
            POSTMARK_API_KEY: your-postmark-api-key
            SECRET_KEY: your-flask-secret-key
            ENVIRONMENT: development
        ports:
            - "8080:8080"
        depends_on:
            core-db:
                condition: service_healthy
        working_dir: /app
        volumes:
            - .:/app
        entrypoint: >
            /bin/sh -c "alembic upgrade head && gunicorn --bind 0.0.0.0:8080 --workers 4 --worker-class uvicorn.workers.UvicornWorker --reload --log-level info --access-logfile - --error-logfile - 'app:asgi_app'"

    core-collector:
        build: .
        container_name: core-collector
        restart: unless-stopped
        environment:
            POSTGRESQL_DATABASE: postgresql+asyncpg://core:core@core-db:5432/default
            # List of OpenBMP collectors
            # https://github.com/OpenBMP/obmp-collector
            OPENBMP_COLLECTORS: openbmp-collector:5000
            # List of Route Views collectors
            # https://www.routeviews.org/
            # ROUTEVIEWS_USERNAME: public
            # ROUTEVIEWS_PASSWORD: public
            # ROUTEVIEWS_COLLECTORS: |
            #    amsix.ams:293,
            #    amsix.ams:1103,
            #    amsix.ams:1140,
            #    amsix.ams:3320,
            #    amsix.ams:6204,
            #    amsix.ams:6777,
            #    amsix.ams:20253,
            #    amsix.ams:28283,
            #    amsix.ams:34177,
            #    amsix.ams:37271,
            #    amsix.ams:39120,
            #    amsix.ams:49544,
            #    amsix.ams:56987,
            #    amsix.ams:213241,
            #    amsix.ams:271253,
            #    amsix.ams:328832,
            #    amsix.ams:398465
            #    amsix:1103,
            #    amsix:3214,
            #    amsix:3399,
            #    amsix:6762,
            #    amsix:6830,
            #    amsix:8888,
            #    amsix:9002,
            #    amsix:12779,
            #    amsix:12859,
            #    amsix:16509,
            #    amsix:16552,
            #    amsix:30844,
            #    amsix:38880,
            #    amsix:39591,
            #    amsix:42541,
            #    amsix:44324,
            #    amsix:47957,
            #    amsix:50763,
            #    amsix:51019,
            #    amsix:51088,
            #    amsix:56662,
            #    amsix:58511,
            #    amsix:60144,
            #    amsix:60150,
            #    amsix:61955,
            #    amsix:199524,
            #    amsix:200242,
            #    amsix:208753,
            #    amsix:211398,
            #    amsix:213151,
            #    amsix:216311,
            #    amsix:267613,
            #    bknix:59238,
            #    bknix:63529,
            #    chicago:293,
            #    chicago:852,
            #    chicago:3257,
            #    chicago:8220,
            #    chicago:14630,
            #    chicago:16509,
            #    chicago:16552,
            #    chicago:17350,
            #    chicago:19151,
            #    chicago:19653,
            #    chicago:20253,
            #    chicago:24115,
            #    chicago:32709,
            #    chicago:49544,
            #    chicago:53828,
            #    chicago:199524,
            #    chicago:398465,
            #    chile:27678,
            #    chile:27986,
            #    cix.atl:13335,
            #    cix.atl:16509,
            #    cix.atl:20253,
            #    cix.atl:20940,
            #    cix.atl:63221,
            #    decix.jhb:16509,
            #    decix.jhb:38137,
            #    decix.jhb:38194,
            #    decix.jhb:199524,
            #    eqix:293,
            #    eqix:2914,
            #    eqix:3257,
            #    eqix:3320,
            #    eqix:6057,
            #    eqix:6079,
            #    eqix:6762,
            #    eqix:6830,
            #    eqix:6939,
            #    eqix:8220,
            #    eqix:8781,
            #    eqix:11039,
            #    eqix:16509,
            #    eqix:16552,
            #    eqix:17350,
            #    eqix:19151,
            #    eqix:20253,
            #    eqix:32098,
            #    eqix:37468,
            #    eqix:37721,
            #    eqix:40934,
            #    eqix:41095,
            #    eqix:49544,
            #    eqix:57695,
            #    eqix:199524,
            #    eqix:398465,
            #    flix:1031,
            #    flix:6939,
            #    flix:7195,
            #    flix:15280,
            #    flix:16509,
            #    flix:16552,
            #    flix:19151,
            #    flix:20253,
            #    flix:28283,
            #    flix:52320,
            #    flix:52468,
            #    flix:63221,
            #    flix:263237,
            #    flix:264409,
            #    fortaleza:1031,
            #    fortaleza:20253,
            #    fortaleza:26162,
            #    fortaleza:28624,
            #    fortaleza:52320,
            #    fortaleza:199524,
            #    fortaleza:262462,
            #    fortaleza:263945,
            #    fortaleza:264409,
            #    fortaleza:264479,
            #    gorex:16509,
            #    gorex:40300,
            #    gorex:65534,
            #    isc:3320,
            #    isc:6762,
            #    isc:6939,
            #    isc:7575,
            #    isc:16509,
            #    isc:19151,
            #    isc:49544,
            #    isc:199524,
            #    kixp:6939,
            #    kixp:16509,
            #    kixp:37271,
            #    kixp:37704,
            #    kixp:63293,
            #    kixp:328475,
            #    kixp:328977,
            #    linx:1031,
            #    linx:2914,
            #    linx:3170,
            #    linx:3257,
            #    linx:3491,
            #    linx:5413,
            #    linx:5511,
            #    linx:6424,
            #    linx:6453,
            #    linx:6667,
            #    linx:6762,
            #    linx:6830,
            #    linx:6939,
            #    linx:8455,
            #    linx:8714,
            #    linx:9002,
            #    linx:13030,
            #    linx:13237,
            #    linx:14537,
            #    linx:16509,
            #    linx:16552,
            #    linx:31500,
            #    linx:34288,
            #    linx:37271,
            #    linx:38182,
            #    linx:38880,
            #    linx:39122,
            #    linx:41811,
            #    linx:47957,
            #    linx:48070,
            #    linx:49544,
            #    linx:58511,
            #    linx:59605,
            #    linx:267613,
            #    linx:398465,
            #    napafrica:3491,
            #    napafrica:16509,
            #    napafrica:16552,
            #    napafrica:32653,
            #    napafrica:37271,
            #    napafrica:37468,
            #    napafrica:49544,
            #    napafrica:199524,
            #    napafrica:328137,
            #    napafrica:328206,
            #    napafrica:328266,
            #    napafrica:328320,
            #    napafrica:328512,
            #    napafrica:328964,
            #    napafrica:329035,
            #    nwax:6423,
            #    nwax:16509,
            #    ny:11399,
            #    ny:13335,
            #    ny:20253,
            #    ny:20940,
            #    ny:28213,
            #    ny:32934,
            #    ny:49544,
            #    ny:63034,
            #    ny:64289,
            #    ny:398465,
            #    pacwave.lax:101,
            #    pacwave.lax:2153,
            #    perth:7594,
            #    perth:7606,
            #    perth:17766,
            #    perth:49544,
            #    perth:58511,
            #    perth:136557,
            #    perth:140627,
            #    perth:199524,
            #    peru:13335,
            #    peru:64115,
            #    phoix:142271,
            #    phoix:150000,
            #    pit.scl:28283,
            #    pit.scl:61522,
            #    pit.scl:64112,
            #    pit.scl:269956,
            #    pitmx.qro:16509,
            #    pitmx.qro:28398,
            #    pitmx.qro:61525,
            #    pitmx.qro:64112,
            #    rio:999,
            #    rio:1031,
            #    rio:6057,
            #    rio:20253,
            #    rio:26162,
            #    rio:52320,
            #    rio:52468,
            #    rio:199524,
            #    rio:264409,
            #    rio:264479,
            #    rio:267613,
            #    route-views2.saopaulo:1031,
            #    route-views2.saopaulo:7195,
            #    route-views2.saopaulo:13786,
            #    route-views2.saopaulo:16552,
            #    route-views2.saopaulo:26162,
            #    route-views2.saopaulo:28329,
            #    route-views2.saopaulo:37468,
            #    route-views2.saopaulo:49544,
            #    route-views2.saopaulo:52468,
            #    route-views2.saopaulo:52863,
            #    route-views2.saopaulo:52873,
            #    route-views2.saopaulo:60503,
            #    route-views2.saopaulo:61832,
            #    route-views2.saopaulo:199524,
            #    route-views2.saopaulo:262791,
            #    route-views2.saopaulo:263009,
            #    route-views2.saopaulo:263237,
            #    route-views2.saopaulo:263541,
            #    route-views2.saopaulo:264409,
            #    route-views2.saopaulo:264479,
            #    route-views2.saopaulo:268976,
            #    route-views2.saopaulo:271253,
            #    route-views2:37100,
            #    route-views3:209,
            #    route-views3:3216,
            #    route-views3:3257,
            #    route-views3:3561,
            #    route-views3:5645,
            #    route-views3:6939,
            #    route-views3:8289,
            #    route-views3:9268,
            #    route-views3:11537,
            #    route-views3:14315,
            #    route-views3:19653,
            #    route-views3:22388,
            #    route-views3:23367,
            #    route-views3:29479,
            #    route-views3:38001,
            #    route-views3:38136,
            #    route-views3:39120,
            #    route-views3:40387,
            #    route-views3:45352,
            #    route-views3:46450,
            #    route-views3:55222,
            #    route-views3:61568,
            #    route-views3:63927,
            #    route-views3:202365,
            #    route-views4:1299,
            #    route-views4:1351,
            #    route-views4:2518,
            #    route-views4:2914,
            #    route-views4:14041,
            #    route-views4:19754,
            #    route-views4:19782,
            #    route-views4:24482,
            #    route-views4:30950,
            #    route-views4:32653,
            #    route-views4:34288,
            #    route-views4:36236,
            #    route-views4:38726,
            #    route-views4:38883,
            #    route-views4:45437,
            #    route-views4:56665,
            #    route-views4:57050,
            #    route-views4:58511,
            #    route-views4:58682,
            #    route-views4:63956,
            #    route-views4:133950,
            #    route-views4:204028,
            #    route-views5:955,
            #    route-views5:1221,
            #    route-views5:11537,
            #    route-views5:13058,
            #    route-views5:19529,
            #    route-views5:22296,
            #    route-views5:33185,
            #    route-views5:37721,
            #    route-views5:41666,
            #    route-views5:49544,
            #    route-views5:56987,
            #    route-views5:58511,
            #    route-views5:60539,
            #    route-views5:132884,
            #    route-views5:137409,
            #    route-views5:199518,
            #    route-views5:207934,
            #    route-views5:208594,
            #    route-views6:209,
            #    route-views6:701,
            #    route-views6:1403,
            #    route-views6:2497,
            #    route-views6:2914,
            #    route-views6:3130,
            #    route-views6:3257,
            #    route-views6:6939,
            #    route-views6:7018,
            #    route-views6:7660,
            #    route-views6:18106,
            #    route-views6:20130,
            #    route-views6:20912,
            #    route-views6:22652,
            #    route-views6:23673,
            #    route-views6:37100,
            #    route-views6:49788,
            #    route-views6:57463,
            #    route-views6:57866,
            #    route-views6:58511,
            #    route-views6:140731,
            #    route-views6:209306,
            #    route-views7:260,
            #    route-views7:924,
            #    route-views7:4641,
            #    route-views7:5580,
            #    route-views7:8582,
            #    route-views7:16260,
            #    route-views7:30371,
            #    route-views7:37989,
            #    route-views7:40864,
            #    route-views7:44620,
            #    route-views7:44901,
            #    route-views7:48297,
            #    route-views7:51999,
            #    route-views7:57344,
            #    route-views7:132213,
            #    route-views7:150369,
            #    route-views7:199310,
            #    route-views7:206271,
            #    route-views7:328977,
            #    route-views7:401021,
            #    route-views:101,
            #    route-views:3333,
            #    route-views:4901,
            #    route-views:20080,
            #    route-views:57866,
            #    sfmix:16509,
            #    sfmix:20253,
            #    sfmix:34927,
            #    sfmix:35008,
            #    sfmix:49544,
            #    sfmix:63055,
            #    sfmix:64289,
            #    sfmix:397131,
            #    sg:3491,
            #    sg:4637,
            #    sg:6762,
            #    sg:7713,
            #    sg:8220,
            #    sg:9002,
            #    sg:9902,
            #    sg:16509,
            #    sg:16552,
            #    sg:17660,
            #    sg:18106,
            #    sg:24115,
            #    sg:24482,
            #    sg:24516,
            #    sg:37468,
            #    sg:38182,
            #    sg:38880,
            #    sg:49544,
            #    sg:58511,
            #    sg:58952,
            #    sg:59318,
            #    sg:63927,
            #    sg:132337,
            #    sg:136106,
            #    sg:136557,
            #    sg:151326,
            #    sg:199524,
            #    soxrs:13004,
            #    soxrs:199524,
            #    sydney:3491,
            #    sydney:4826,
            #    sydney:7575,
            #    sydney:7594,
            #    sydney:8888,
            #    sydney:9266,
            #    sydney:16552,
            #    sydney:24115,
            #    sydney:24516,
            #    sydney:58511,
            #    sydney:63956,
            #    sydney:132847,
            #    sydney:135895,
            #    sydney:148968,
            #    sydney:199524,
            #    sydney:398465,
            #    telxatl:4181,
            #    telxatl:6082,
            #    telxatl:6939,
            #    telxatl:16509,
            #    telxatl:19151,
            #    telxatl:20253,
            #    telxatl:32299,
            #    telxatl:53828,
            #    uaeix:16509,
            #    uaeix:42473,
            #    uaeix:49544,
            #    uaeix:60924,
            #    uaeix:61374,
            #    uaeix:199524,
            #    wide:2497,
            #    wide:2500,
            #    wide:2516,
            #    wide:7500
            # List of RIPE Route Collectors
            # https://ris.ripe.net
            RIS_USERNAME: public
            RIS_PASSWORD: public
            RIS_COLLECTORS: |
                rrc00,
                rrc01
            #    rrc03,
            #    rrc04,
            #    rrc05,
            #    rrc06,
            #    rrc07,
            #    rrc10,
            #    rrc11,
            #    rrc12,
            #    rrc13,
            #    rrc14,
            #    rrc15,
            #    rrc16,
            #    rrc18,
            #    rrc19,
            #    rrc20,
            #    rrc21,
            #    rrc22,
            #    rrc23,
            #    rrc24,
            #    rrc25,
            #    rrc26
        depends_on:
            openbmp-collector:
                condition: service_healthy
        working_dir: /app
        volumes:
            - .:/app
        entrypoint: >
            python app.py --service collector

    #core-aggregator:
    #    build: .
    #    container_name: core-aggregator
    #    environment:
    #        POSTGRESQL_DATABASE: postgresql+asyncpg://core:core@core-db:5432/default
    #    depends_on:
    #        core-db:
    #            condition: service_healthy
    #        openbmp-db:
    #            condition: service_healthy
    #    working_dir: /app
    #    volumes:
    #        - .:/app
    #    entrypoint: >
    #        python app.py --service aggregator

    ###
    # OpenBMP (Open Border Gateway Protocol Monitoring Protocol) services
    #
    # These services are responsible for collecting, storing, and analyzing BGP data.
    # They consume BGP messages from a Kafka stream, process them, and store the results
    # in a PostgreSQL database. The data is then used to provide insights into the global
    # routing table, including route visibility, prefix reachability, and AS path analysis.
    #
    # The 'openbmp-db' service manages the PostgreSQL database where the processed BGP
    # data is stored. It ensures data integrity, handles database migrations, and provides
    # a reliable storage backend for the OpenBMP application.
    #
    # The 'openbmp-whois' service provides a whois service for the BGP data. It allows users
    # to query the database for whois information about BGP peers.
    #
    # The 'openbmp-zookeeper' service manages the Zookeeper cluster, providing a centralized
    # coordination service for the Kafka cluster. It ensures that the Kafka brokers are
    # properly configured and synchronized, maintaining a consistent state across the cluster.
    #
    # The 'openbmp-kafka' service connects to the Kafka stream, consumes BGP messages,
    # and processes them in real-time. It ensures that the data is correctly formatted
    # and ready for storage in the PostgreSQL database.
    #
    # The 'openbmp-app' service provides a web interface and API for accessing the stored
    # BGP data. It allows users to query the database, visualize BGP data, and generate
    # reports on routing behavior and anomalies.
    #
    # The 'openbmp-collector' service ingests BMP messages from the 'core-collector' service.
    # Which is collecting from various other collectors and RIB dumps.
    #
    # The 'openbmp-grafana' service provides a Grafana dashboard for visualizing the data
    # collected and processed by the application, offering insights and monitoring capabilities.
    ###
    openbmp-db:
        container_name: openbmp-db
        image: openbmp/postgres:2.2.1
        platform: linux/amd64
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U openbmp"]
            interval: 30s
            timeout: 10s
            retries: 5
        privileged: true
        shm_size: 1536m
        ports:
            - "5433:5432"
        sysctls:
            - net.ipv4.tcp_keepalive_intvl=30
            - net.ipv4.tcp_keepalive_probes=5
            - net.ipv4.tcp_keepalive_time=180
        volumes:
            - obmp_pg_data:/var/lib/postgresql/data
            - obmp_ts_data:/var/lib/postgresql/ts
        command: >
            -c max_wal_size=10GB
        environment:
            POSTGRES_PASSWORD: openbmp
            POSTGRES_USER: openbmp
            POSTGRES_DB: openbmp
        
    openbmp-app:
        container_name: openbmp-app
        image: openbmp/psql-app:2.2.2
        platform: linux/amd64
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9005"]
            interval: 30s
            timeout: 10s
            retries: 3
        sysctls:
            - net.ipv4.tcp_keepalive_intvl=30
            - net.ipv4.tcp_keepalive_probes=5
            - net.ipv4.tcp_keepalive_time=180
        depends_on:
            openbmp-db:
                condition: service_healthy
            openbmp-kafka:
                condition: service_healthy
        ports:
            - "9005:9005"
        volumes:
            - ./config:/config
        environment:
            MEM: 3                                           # Set memory to at least 2GB but ideally 4GB
            KAFKA_FQDN: openbmp-kafka:29092
            RPKI_URL: https://rpki.cloudflare.com/rpki.json  # define the URL to retrieve json endoed RPKI data
            RPKI_PASS: None
            RPKI_USER: None
            ENABLE_RPKI: 1                                   # 1 enables, 0 disables RPKI sync
            ENABLE_IRR: 1                                    # 1 enables, 0 disables IRR sync
            ENABLE_DBIP: 1                                   # 1 enables, 0 disables DBIP import
            POSTGRES_REPORT_WINDOW: '8 minute'               # default POSTGRESS window to select when building
                                                             #   summary tables. For deployments that absorb large
                                                             #   bursts increase the value, ex 60 minute
            POSTGRES_PASSWORD: openbmp
            POSTGRES_USER: openbmp
            POSTGRES_DB: openbmp
            POSTGRES_HOST: openbmp-db
            POSTGRES_PORT: 5432
            POSTGRES_DROP_peer_event_log: '1 month'
            POSTGRES_DROP_stat_reports: '1 day'
            POSTGRES_DROP_ip_rib_log: '1 day'
            POSTGRES_DROP_alerts: '1 day'
            POSTGRES_DROP_ls_nodes_log: '2 days'
            POSTGRES_DROP_ls_links_log: '2 days'
            POSTGRES_DROP_ls_prefixes_log: '2 days'
            POSTGRES_DROP_stats_chg_byprefix: '1 day'
            POSTGRES_DROP_stats_chg_byasn: '1 day'
            POSTGRES_DROP_stats_chg_bypeer: '1 day'
            POSTGRES_DROP_stats_ip_origins: '1 day'
            POSTGRES_DROP_stats_peer_rib: '1 day'
            POSTGRES_DROP_stats_peer_update_counts: '1 day'

    openbmp-collector:
        container_name: openbmp-collector
        platform: linux/amd64
        restart: unless-stopped
        healthcheck:
            test: ["CMD-SHELL", "cat", "< /dev/null >", "/dev/tcp/localhost/5000"]
            interval: 30s
            timeout: 10s
            retries: 3
        image: openbmp/collector:2.2.3
        sysctls:
            - net.ipv4.tcp_keepalive_intvl=30
            - net.ipv4.tcp_keepalive_probes=5
            - net.ipv4.tcp_keepalive_time=180
        volumes:
            - ./config:/config
        environment:
            KAFKA_FQDN: openbmp-kafka:29092

    openbmp-whois:
        container_name: openbmp-whois
        image: openbmp/whois:2.2.0
        platform: linux/amd64
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:43"]
            interval: 30s
            timeout: 10s
            retries: 3
        sysctls:
            - net.ipv4.tcp_keepalive_intvl=30
            - net.ipv4.tcp_keepalive_probes=5
            - net.ipv4.tcp_keepalive_time=180
        volumes:
            - ./config:/config
        depends_on:
            openbmp-db:
                condition: service_healthy
        ports:
            - "4300:43"
        environment:
            POSTGRES_PASSWORD: openbmp
            POSTGRES_USER: openbmp
            POSTGRES_DB: openbmp
            POSTGRES_HOST: openbmp-db
            POSTGRES_PORT: 5433

    openbmp-zookeeper:
        container_name: openbmp-zookeeper
        image: confluentinc/cp-zookeeper:7.1.1
        platform: linux/amd64
        restart: unless-stopped
        volumes:
            - obmp_zk_data:/var/lib/zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000

    openbmp-kafka:
        container_name: openbmp-kafka
        image: confluentinc/cp-kafka:7.1.1
        platform: linux/amd64
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "openbmp-kafka:29092"]
            interval: 30s
            timeout: 10s
            retries: 10
        # Change the mount point to where you want to store Kafka data.
        #   Normally 80GB or more
        volumes:
            - obmp_kf_data:/var/lib/kafka/data
        ports:
            - "9092:9092"
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: openbmp-zookeeper:2181
            # Change/add listeners based on your FQDN that the host and other containers can access.  You can use
            #    an IP address as well. By default, only within the compose/containers can Kafka be accesssed
            #    using port 29092. Outside access can be enabled, but you should use an FQDN listener.
            #KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://<FQDN>:9092
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://openbmp-kafka:29092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_NUM_PARTITIONS: 8
            KAFKA_LOG_RETENTION_MINUTES: 90
            KAFKA_LOG_ROLL_MS: 3600000
            KAFKA_LOG_SEGMENT_BYTES: 1073741824
            KAFKA_MESSAGE_MAX_BYTES: 100000000
            KAFKA_LOG_CLEANER_THREADS: 2

    openbmp-grafana:
        container_name: openbmp-grafana
        image: grafana/grafana:9.1.7
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:3000"]
            interval: 30s
            timeout: 10s
            retries: 3
        ports:
            - "3000:3000"
        volumes:
            - ./grafana:/var/lib/grafana
            - ./grafana/provisioning/:/etc/grafana/provisioning/
        environment:
            GF_SECURITY_ADMIN_PASSWORD: openbmp
            GF_AUTH_ANONYMOUS_ENABLED: true
            GF_USERS_HOME_PAGE: d/obmp-home/obmp-home
            GF_INSTALL_PLUGINS: agenty-flowcharting-panel,grafana-piechart-panel,grafana-worldmap-panel,grafana-simple-json-datasource,vonage-status-panel

# Define volumes
volumes:
    core_pg_data:
    obmp_pg_data:
    obmp_ts_data:
    obmp_zk_data:
    obmp_kf_data: