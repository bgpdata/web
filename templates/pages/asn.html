{% extends 'base.html' %}

{% block title %}
AS{{ asn }} {{ as_name }}
{% endblock %}

{% block headers %}
<!-- IBM Carbon Components -->
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/version/v2.31.0/dropdown.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/version/v2.25.2/text-input.min.js"></script>
<script type="module" src="https://1.www.s81c.com/common/carbon/web-components/version/v2.31.0/data-table.min.js"></script>
<!-- IBM Carbon Charts -->
<script src="https://cdn.jsdelivr.net/npm/@carbon/charts@1/dist/umd/bundle.umd.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/@carbon/charts@1/styles.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="content__asn">
    <div class="asn__header">
        <div class="header__wrapper">
            <div class="wrapper__container">
                <div class="container__breadcrumbs">
                    <a href="/" class="breadcrumbs__item">Home</a>
                </div>
                <h2 class="container__title" id="asn">
                    AS{{ asn }}{% if as_name %}&nbsp;-&nbsp;{{ as_name }}{% endif %}
                </h2>
            </div>
        </div>
    </div>
    <div class="asn__tabs">
        <div class="tabs__wrapper">
            <div class="wrapper__container">
                <div class="container__tabs" id="tabs">
                    <div class="tab__item tab__item--active" target="overview">
                        Overview
                    </div>
                    <div class="tab__item" target="prefixes">
                        All Prefixes
                    </div>
                    <div class="tab__item" target="connectivity">
                        Connectivity
                    </div>
                    <div class="tab__item" target="activity">
                        Activity
                    </div>
                    <div class="tab__item" target="whois">
                        Whois
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="asn__content">
        <div class="content__wrapper">
            <div class="wrapper__container">
                <div class="container__content">
                    <div class="content__panel" id="overview" aria-labelledby="tab-overview">
                        <div class="panel__header">
                            <div class="header__description">
                                Comprehensive view of ASN routing information, including advertised prefixes, upstream and downstream connections, and historical trend data for network analysis.
                            </div>
                            <div class="header__controls">
                                <cds-dropdown value="option-7" class="cds-theme-zone-white" size="lg" style="width: 18rem; font-size: 1rem; font-weight: 350;" disabled>
                                    <cds-dropdown-item value="option-0">Last 5 minutes</cds-dropdown-item>
                                    <cds-dropdown-item value="option-1">Last 15 minutes</cds-dropdown-item>
                                    <cds-dropdown-item value="option-2">Last 30 minutes</cds-dropdown-item>
                                    <cds-dropdown-item value="option-3">Last 1 hour</cds-dropdown-item>
                                    <cds-dropdown-item value="option-4">Last 3 hours</cds-dropdown-item>
                                    <cds-dropdown-item value="option-5">Last 6 hours</cds-dropdown-item>
                                    <cds-dropdown-item value="option-6">Last 12 hours</cds-dropdown-item>
                                    <cds-dropdown-item value="option-7">Last 24 hours</cds-dropdown-item>
                                    <cds-dropdown-item value="option-8">Last 2 days</cds-dropdown-item>
                                    <cds-dropdown-item value="option-10">Last 7 days</cds-dropdown-item>
                                    <cds-dropdown-item value="option-11">Last 30 days</cds-dropdown-item>
                                </cds-dropdown>
                            </div>
                        </div>
                        <div class="panel__content">
                            <div class="content__metrics">
                                <div class="metrics__card">
                                    <div class="card__eyebrow">IPv4</div>
                                    <div class="card__description">Advertised IPv4 Prefixes</div>
                                    <div class="card__value">{{ ipv4_count }}</div>
                                </div>
                                <div class="metrics__card">
                                    <div class="card__eyebrow">IPv6</div>
                                    <div class="card__description">Advertised IPv6 Prefixes</div>
                                    <div class="card__value">{{ ipv6_count }}</div>
                                </div>
                                <div class="metrics__card">
                                    <div class="card__eyebrow">Upstream ASNs</div>
                                    <div class="card__description">Routes received from</div>
                                    <div class="card__value">{{ upstream_count }}</div>
                                </div>
                                <div class="metrics__card">
                                    <div class="card__eyebrow">Downstream ASNs</div>
                                    <div class="card__description">Routes provided to</div>
                                    <div class="card__value">{{ downstream_count }}</div>
                                </div>
                            </div>
                            <div class="content__charts">
                                <div class="charts__item charts__item--span-11-columns" id="trend-graph"></div>
                                <div class="charts__item charts__item--span-5-columns" id="ips-graph"></div>
                            </div>
                            <div class="content__tables">
                                <cds-table class="tables__item tables__item--span-16-columns cds-theme-zone-white" with-header="true">
                                    <cds-table-header-title slot="title" style="font-size: 1rem; margin-bottom: 0.5rem;">
                                        ASN Information
                                    </cds-table-header-title>
                                    <cds-table-header-description slot="description" style="font-weight: 250; font-size: 1rem; margin-bottom: -0.5rem; letter-spacing: 0.2px;">
                                        Information from various public datasets
                                    </cds-table-header-description>
                                    <cds-table-head>
                                        <cds-table-header-row>
                                            <cds-table-header-cell>AS Name</cds-table-header-cell>
                                            <cds-table-header-cell>Org Id</cds-table-header-cell>
                                            <cds-table-header-cell>Org Name</cds-table-header-cell>
                                            <cds-table-header-cell>Address</cds-table-header-cell>
                                            <cds-table-header-cell>City</cds-table-header-cell>
                                            <cds-table-header-cell>State/Prov</cds-table-header-cell>
                                            <cds-table-header-cell>Country</cds-table-header-cell>
                                            <cds-table-header-cell>Source</cds-table-header-cell>
                                        </cds-table-header-row>
                                    </cds-table-head>
                                    <cds-table-body>
                                        <cds-table-row>
                                            <cds-table-cell>{{ asn_info.as_name }}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.org_id }}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.org_name }}</cds-table-cell>
                                            <cds-table-cell>{% if asn_info.address == ', ' %}{% else %}{{ asn_info.address }}{% endif %}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.city }}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.state_prov }}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.country }}</cds-table-cell>
                                            <cds-table-cell>{{ asn_info.source }}</cds-table-cell>
                                        </cds-table-row>
                                    </cds-table-body>
                                </cds-table>
                                <cds-table class="tables__item tables__item--span-8-columns cds-theme-zone-white" with-header="true" style="height: fit-content;">
                                    <cds-table-header-title slot="title" style="font-size: 1rem; margin-bottom: 0.5rem;">
                                        Upstream ASNs
                                    </cds-table-header-title>
                                    <cds-table-header-description slot="description" style="font-weight: 250; font-size: 1rem; margin-bottom: -0.5rem; letter-spacing: 0.2px;">
                                        ASNs that have routes to this ASN
                                    </cds-table-header-description>
                                    <cds-table-head>
                                        <cds-table-header-row>
                                            <cds-table-header-cell>ASN</cds-table-header-cell>
                                            <cds-table-header-cell>Name</cds-table-header-cell>
                                        </cds-table-header-row>
                                    </cds-table-head>
                                    <cds-table-body>
                                        {% for upstream_asn in upstream_asns %}
                                        <cds-table-row>
                                            <cds-table-cell>AS{{ upstream_asn.asn }}</cds-table-cell>
                                            <cds-table-cell>{{ upstream_asn.name }}</cds-table-cell>
                                        </cds-table-row>
                                        {% endfor %}
                                    </cds-table-body>
                                </cds-table>
                                <cds-table class="tables__item tables__item--span-8-columns cds-theme-zone-white" with-header="true" style="height: fit-content;">
                                    <cds-table-header-title slot="title" style="font-size: 1rem; margin-bottom: 0.5rem;">
                                        Downstream ASNs
                                    </cds-table-header-title>
                                    <cds-table-header-description slot="description" style="font-weight: 250; font-size: 1rem; margin-bottom: -0.5rem; letter-spacing: 0.2px;">
                                        ASNs that this ASN has routes to
                                    </cds-table-header-description>
                                    <cds-table-head>
                                        <cds-table-header-row>
                                            <cds-table-header-cell>ASN</cds-table-header-cell>
                                            <cds-table-header-cell>Name</cds-table-header-cell>
                                        </cds-table-header-row>
                                    </cds-table-head>
                                    <cds-table-body>
                                        {% for downstream_asn in downstream_asns %}
                                        <cds-table-row>
                                            <cds-table-cell>AS{{ downstream_asn.asn }}</cds-table-cell>
                                            <cds-table-cell>{{ downstream_asn.name }}</cds-table-cell>
                                        </cds-table-row>
                                        {% endfor %}
                                    </cds-table-body>
                                </cds-table>
                            </div>
                        </div>
                    </div>
                    <div class="content__panel" id="prefixes" aria-labelledby="tab-prefixes">
                        <div class="panel__content">
                            <div class="content__tables">
                                <cds-table class="tables__item tables__item--span-16-columns cds-theme-zone-white" with-header="true">
                                    <cds-table-header-title slot="title" style="font-size: 1rem; margin-bottom: 0.5rem;">
                                        Aggregates
                                    </cds-table-header-title>
                                    <cds-table-header-description slot="description" style="font-weight: 250; font-size: 1rem; margin-bottom: -0.5rem; letter-spacing: 0.2px;">
                                        All prefixes advertised by this ASN
                                    </cds-table-header-description>
                                    <cds-table-head>
                                        <cds-table-header-row>
                                            <cds-table-header-cell>Prefix</cds-table-header-cell>
                                        </cds-table-header-row>
                                    </cds-table-head>
                                    <cds-table-body>
                                        {% for prefix in prefixes_aggregates %}
                                        <cds-table-row>
                                            <cds-table-cell>{{ prefix }}</cds-table-cell>
                                        </cds-table-row>
                                        {% endfor %}
                                    </cds-table-body>
                                </cds-table>

                                <cds-table class="tables__item tables__item--span-16-columns cds-theme-zone-white" with-header="true">
                                    <cds-table-header-title slot="title" style="font-size: 1rem; margin-bottom: 0.5rem;">
                                        Advertised Prefixes
                                    </cds-table-header-title>
                                    <cds-table-header-description slot="description" style="font-weight: 250; font-size: 1rem; margin-bottom: -0.5rem; letter-spacing: 0.2px;">
                                        All prefixes advertised by this ASN, including multiple entries from IRR databases
                                    </cds-table-header-description>
                                    <cds-table-toolbar slot="toolbar">
                                        <cds-table-toolbar-content ?has-batch-actions="true">
                                            <cds-table-toolbar-search placeholder="Filter prefixes"></cds-table-toolbar-search>
                                        </cds-table-toolbar-content>
                                    </cds-table-toolbar>
                                    <cds-table-head>
                                        <cds-table-header-row>
                                            <cds-table-header-cell>Prefix</cds-table-header-cell>
                                            <cds-table-header-cell>RPKI Origin AS</cds-table-header-cell>
                                            <cds-table-header-cell>IRR Origin AS</cds-table-header-cell>
                                            <cds-table-header-cell>Last Change</cds-table-header-cell>
                                            <cds-table-header-cell>IRR Description</cds-table-header-cell>
                                            <cds-table-header-cell>IRR Source</cds-table-header-cell>
                                        </cds-table-header-row>
                                    </cds-table-head>
                                    <cds-table-body>
                                        {% for prefix in prefixes %}
                                        <cds-table-row>
                                            <cds-table-cell>{{ prefix.prefix }}</cds-table-cell>
                                            <cds-table-cell>{{ prefix.rpki_origin_as or '' }}</cds-table-cell>
                                            <cds-table-cell>{{ prefix.irr_origin_as or '' }}</cds-table-cell>
                                            <cds-table-cell>{{ prefix.last_changed or '' }}</cds-table-cell>
                                            <cds-table-cell>{{ prefix.irr_description or '' }}</cds-table-cell>
                                            <cds-table-cell>{{ prefix.irr_source or '' }}</cds-table-cell>
                                        </cds-table-row>
                                        {% endfor %}
                                    </cds-table-body>
                                </cds-table>
                            </div>
                        </div> 
                    </div>
                    <div class="content__panel" id="connectivity" aria-labelledby="tab-connectivity">
                        Tab Panel 3
                    </div>
                    <div class="content__panel" id="activity" aria-labelledby="tab-activity">
                        Tab Panel 4
                    </div>
                    <div class="content__panel" id="whois" aria-labelledby="tab-whois">
                        Tab Panel 5
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const tabs = document.querySelectorAll('.tab__item');
    const panels = document.querySelectorAll('.content__panel');
    
    // Function to switch tabs
    const switchTab = (targetId) => {
        // Update URL hash without triggering scroll
        if (targetId !== 'overview') {
            history.replaceState(null, null, `#${targetId}`);
        } else {
            history.replaceState(null, null, window.location.pathname);
        }
        
        // Update active tab
        tabs.forEach(tab => {
            if (tab.getAttribute('target') === targetId) {
                tab.classList.add('tab__item--active');
            } else {
                tab.classList.remove('tab__item--active');
            }
        });
        
        // Show corresponding panel
        panels.forEach(panel => {
            if (panel.id === targetId) {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        });
    };
    
    // Add click handlers to tabs
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetId = tab.getAttribute('target');
            switchTab(targetId);
        });
    });
    
    // Handle initial load and hash changes
    const handleHashChange = () => {
        const hash = window.location.hash.slice(1) || 'overview';
        switchTab(hash);
    };
    
    // Listen for hash changes
    window.addEventListener('hashchange', handleHashChange);
    
    // Initial load
    handleHashChange();
});
</script>
<script>
    BGPDATA.create(
      "bgp-explorer",
      {
        resource: "2409:875c:8500::/40",
        rrcs: "0,1,2,3",
        unix_timestamps: "TRUE",
        ignoreReannouncements: true,
        starttime: 1728129599,
        endtime: 1728215999,
      },
      "bgp-explorer",
      { disable: ["controls"] },
    );
</script>
<script>
    const data = {{ trend_data|tojson }}.flatMap(item => [
        { date: item.time, value: item.v4_prefixes, group: 'IPv4 Prefixes' },
        { date: item.time, value: item.v6_prefixes, group: 'IPv6 Prefixes' },
        { date: item.time, value: item.v4_with_rpki, group: 'IPv4 with RPKI' },
        { date: item.time, value: item.v6_with_rpki, group: 'IPv6 with RPKI' },
        { date: item.time, value: item.v4_with_irr, group: 'IPv4 with IRR' },
        { date: item.time, value: item.v6_with_irr, group: 'IPv6 with IRR' }
    ]);
    // Grab chart holder HTML element and initialize the chart
    new Charts.LineChart(document.getElementById("trend-graph"), {
        data,
        options: {
            title: 'Originating Prefix Trend',
            axes: {
                bottom: {
                    title: 'Time',
                    mapsTo: 'date',
                    scaleType: 'time'
                },
                left: {
                    mapsTo: 'value',
                    title: 'Prefixes',
                    scaleType: 'linear'
                }
            },
            height: '400px',
            color: {
                scale: {
                    "IPv4 Prefixes": "#204ff5",
                    "IPv6 Prefixes": "#d82e8a",
                    "IPv4 with RPKI": "#4abea0",
                    "IPv6 with RPKI": "#ffde02",
                    "IPv4 with IRR": "#a3b2b9",
                    "IPv6 with IRR": "#161616"
                }
            }
        }
    });
</script>
<script>
    // Grab chart holder HTML element and initialize the chart
    new Charts.PieChart(document.getElementById("ips-graph"), {
        data: [
            {
                group: 'IPv4',
                value: {{ ipv4_count }}
            },
            {
                group: 'IPv6',
                value: {{ ipv6_count }}
            }
        ],
        options: {
            title: 'Advertised IP Addresses',
            height: '400px',
            color: {
                scale: {
                    "IPv4": "#204ff5",
                    "IPv6": "#a3b2b9"
                }
            }
        }
    });
</script>
{% endblock %}